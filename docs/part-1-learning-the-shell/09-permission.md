# 9. 许可

Unix 传统的操作系统区别于 MS-DOS 传统的，不仅仅在于<u>多任务</u>（*multitasking*），而且在于<u>多用户</u>（*multi-user*）。

这意味着什么呢？意味着在同一时间，允许多个用户使用计算机。典型的计算机只有一个键盘和监视器，不过仍允许多个用户使用。例如，如果一台计算机连接到一个网络或者互联网，远程用户可以通过 `ssh`（secure shell）登录并操作计算机。实际上，远程用户能执行图形应用，可以将图形输出显示到远程桌面。X 窗口系统作为其基本设计的一部分，支持该操作。

Linux 的多用户能力不是新近的「创新」，而是深深嵌入到操作系统的设计之中的一个特性。考虑创造 Unix 时的环境因素，这一点非常有意义。在计算机成为「个人」的多年之前，它们大而昂贵，而且是集中化的。一个典型的大学计算机系统，例如，由一个位于一个建筑内的大型中央计算机和遍布校园的连接到大型中央计算机的终端所组成。计算机会在同一时间支持多个用户。

要做到这一点，必须设计一个方案以各自保护用户。然后，一个用户的行为不会导致计算机崩溃，也不会干预属于其他用户的文件。

本章中，我们要看一下系统安全的基本内容，介绍下列命令：

- `id` 显示用户身份
- `chmod` 变更文件的模式
- `umask` 设置缺省情况下的文件许可
- `su` 以另一个用户运行 shell
- `sudo` 以另一个用户执行一个命令
- `chown` 变更文件属主
- `chgrp` 变更文件属组
- `passwd` 变更用户密码

## 属主、组成员、其他人

第 3 章中，当我们浏览系统，试着检查一个文件，如 `/etc/shadow` 时，我们可能就遇到一个问题。

```bash
[me@linuxbox ~]$ file /etc/shadow
/etc/shadow: regular file, no read permission
[me@linuxbox ~]$ less /etc/shadow
/etc/shadow: Permission denied
```

这个错误的原因是，作为一个普通用户，我们读取这个文件的许可。

在 Unix 安全模型中，一个用户可以<u>拥有</u>（*own*）文件和目录。当一个用户拥有一个文件或目录，该用户可以控制其访问权限。反之，用户们可以属于由一个或多个用户组成的<u>组</u>（*group*），由文件和目录的属主授权接入。在授权一个组接入的同时，属主也可以授予一些接入权限给所有人，在 Unix 术语中被称为<u>世界</u>（*world*）。要查阅关于你自己的身份信息，使用 `id` 命令。

```bash
[me@linuxbox ~]$ id
uid=500(me) gid=500(me) groups=500(me)
```

来看一下输出结果。当创建用户帐户时，会分配给用户一个被称为<u>用户 ID</u>（*user id* 即 *uid*）的数字，同时，为了人类可读的缘故，被映射到一个用户名。用户被分配一个<u>主组 ID</u>（*primary group id* 即 *gid*），也可以属于其它附加的组。上面的例子来自 Fedora 系统。其它系统上，如 Ubuntu，输出可能会有所不同：

```bash
[me@linuxbox ~]$ id
uid=1000(me) gid=1000(me)
groups=4(adm),20(dialout),24(cdrom),25(floppy),29(audio),30(dip),44(v
ideo),46(plugdev),108(lpadmin),114(admin),1000(me)
```

我们看到，uid 和 gid 的数字在两个系统中是不同的。一个简单的理由是，Fedora 的常规用户帐号数字从 500 开始，Ubuntu 则始于 1000。我们还看到 Ubuntu 用户属于更多的组。这与 Ubuntu 管理系统设备和服务权限的方式有关。

那么，这信息从哪儿来？和 Linux 大多数情况相仿，来自一堆文本文件。用户帐户在 `/etc/passwd` 文件中被定义，组帐户在 `/etc/group` 文件中被定义。当用户帐户和组别被创建时，这些文件随着保存用户密码的文件 `/etc/shadow` 同时被修改。对于每个用户帐户，`/etc/passwd` 文件定义其用户名（登录名）、uid、gid、帐户实名、家目录和登录所用的 shell。如果我们检查 `/etc/passwod` 和 `/etc/group` 文件的内容，可以注意到除了常规用户帐户，还有超级用户（uid 0）和其他各种系统用户。

下一章中，当我们学习进程的时候，我们会看到这些其他系统「用户」实际上相当忙碌。

很多类 Unix 系统将常规用户分配到一个诸如「users」的组别，而现代 Linux 则创建一个唯一的与用户同名的单用户组。这会使许可分配更容易。

## 读、写、执行

对文件和目录而言，接入权利定义为读、写、执行三者。如果我们看  `ls` 命令的输出，能得到一些线索，来看这是如何得以实现的：

```bash
[me@linuxbox ~]$ > foo.txt
[me@linuxbox ~]$ ls -l foo.txt
-rw-rw-r-- 1 me me 0 2016-03-06 14:52 foo.txt
```

前 10 个字符是文件属性。其中第 1 个字符是文件类型。表 9-1 描述了最常见的文件类型（还有一些不常用的类型）：

表 9-1 文件类型

| 属性 | 文件类型                                                     |
| ---- | ------------------------------------------------------------ |
| `-`  | 常规文件                                                     |
| `d`  | 目录                                                         |
| `l`  | 符号链接。注意符号链接的其他文件属性总是 `rwxrwxrwx` 这样虚设的值，真实的文件属性是那些符号链接所指向的文件。 |
| `c`  | 字符特殊文件。该类型指将数据处理为比特流的设备，如终端或 `/dev/null`。 |
| `b`  | 块特殊文件。该类型指将数据处理为块的设备，如硬盘或 DVD 驱动器。 |

余下九个文件属性字符，叫做<u>文件模式</u>（*file mode*），表示文件属主、属组、其他人对文件的读、写和执行权限。

| Owner | Group | World |
| :---: | :---: | :---: |
| `rwx` | `rwx` | `rwx` |

表 9-2 描述了 `r`、`w`、`x` 模式属性对文件和目录的影响。

表 9-2：许可属性

| 属性 | 文件                                                         | 目录                                                         |
| ---- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| `r`  | 允许打开、读取一个文件。                                     | 如果同时设置了执行权限，则允许列出目录的内容。               |
| `w`  | 允许写入或截断一个文件。不过这个属性并不允许重命名或删除文件，重命名和删除文件的权限取决于所在目录的属性。 | 如果同时设置了执行权限，则允许在该目录中创建、删除、重命名文件。 |
| `x`  | 允许将一个文件作为程序被执行。用脚本语言写成的程序文件必须同时被设置为可读、可执行。 | 允许进入该目录。如 `cd` *directory*。                        |

表 9-3 提供了一些文件属性设置的案例：

表 9-3 许可属性示例

| 文件属性     | 意义                                                         |
| ------------ | ------------------------------------------------------------ |
| `-rwx------` | 一个常规文件，属主可读可写可执行，其他用户不能接入该文件。   |
| `-rw-------` | 一个常规文件，属主可读可写，其他用户不能接入该文件。         |
| `-rw-r--r--` | 一个常规文件，属主可读可写，组成员可读，其他用户可读。       |
| `-rwxr-xr-x` | 一个常规文件，属主可读可写可执行，其他用户可读可执行。       |
| `-rw-rw----` | 一个常规文件，属主所在组的成员可读可写，其他用户不能接入该文件。 |
| `lrwxrwxrwx` | 一个符号链接。所有符号链接的许可都是「假」的，真实的许可权限由符号链接所指向的文件决定。 |
| `drwxrwx---` | 一个目录。属主和组成员能进入该目录并创建、重命名、删除文件。 |
| `drwxr-x---` | 一个目录。属主能进入该目录并创建、重命名、删除文件。组成员能进入目录，单不能创建、删除或重命名文件。 |

### chmod - 改变文件模式

要改变文件或目录的模式（许可），用 `chmod` 命令。注意只有文件的属主或超级用户能改变文件或目录的模式。`chmod` 支持两种不同的方法来指定模式变更：八进制或符号表示法。我们首先学习八进制表示法。

> **到底什么是八进制？**
>
> 八进制，和它的表亲，十六进制是用来在计算机中表示数字的数字系统。我们人类，因为多数是天生十根手指，所以数数用的是十进制。计算机不然，天生只有一根手指，所以只能用二进制数数。它们的数字系统只有两个数字，0 和 1.所以在二进制，数数是这样的：
>
> 0, 1, 10, 11, 100, 101, 110, 111, 1000, 1001, 1010, 1011...
>
> 八进制，用零到七这几个数字来计数，像这样：
>
> 0, 1, 2, 3, 4, 5, 6, 7, 10, 11, 12, 13, 14, 15, 16, 17, 20, 21...
>
> 十六进制，用零到九加字母「A」到「F」来计数：
>
> 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, A, B, C, D, E, F, 10, 11, 12, 13...
>
> 我们能理解二进制（因为计算机只有一根手指），那八进制和十六进制有什么好处呢？答案是为了方便人类。很多时候，计算机中的小部分数据被表述为<u>位模式</u>（*bit patterns*）。以 RGB 颜色为例。大多数计算机显示，每个像素由三个颜色成分组成：八位的红、八位的绿、八位的蓝。可爱的中蓝色，会有 24 位数字：
>
> 010000110110111111001101
>
> 你怎么会喜欢每天在读写这种数字吗？我想是不会的。这里有另外一个数字系统，会有所帮助。每个十六进制的数字表示四个二进制数字，八进制中，每个数字表示三个二进制数字。所以我们的 24 位中蓝色数字可以被浓缩为六位十六进制数字：
>
> 436FCD
>
> 由于十六进制的数字与二进制数字是对齐的，我们可以看到颜色中的红色部分是 43，绿色是 6F，蓝色是 CD。
>
> 当前，十六进制表示法（经常写成「hex」），比八进制更通用，但是我们马上就能看到，八进制表示三位二进制的能力会非常有用……

随八进制表示法，我们用八个数字设置所需权限的模式。因为每个八进制数字表示三个二进制数字，非常好地映射到存储文件模式的方案。表 9-4 显示了具体含义。

表 9-4：二进制和八进制的文件模式

| 八进制 | 二进制 | 文件模式 |
| ------ | ------ | -------- |
| `0`       |  `000`      | `---`         |
| `1`       |  `001`      | `--x`         |
| `2`       |  `010`      | `-w-`         |
| `3`       |  `011`      | `-wx`         |
| `4`       |  `100`      | `r--`         |
| `5`       |  `101`      | `r-x`         |
| `6`       |  `110`      | `rw-`         |
| `7`       |  `111`      | `rwx`         |

使用三位八进制数字，我们能为属主、组成员和全部人员设置文件模式。

```bash
[me@linuxbox ~]$ > foo.txt
[me@linuxbox ~]$ ls -l foo.txt
-rw-rw-r-- 1 me  me  0 2016-03-06 14:52 foo.txt
[me@linuxbox ~]$ chmod 600 foo.txt
[me@linuxbox ~]$ ls -l foo.txt
-rw------- 1 me  me  0 2016-03-06 14:52 foo.txt
```

传递参数「600」，我们可以设置属主的权限为可读可写并删除其他用户的所有权限。尽管看起来记住八进制到二进制的映射看起来很不方便，我们通常仅需要使用几个常用的：`7 (rwx)`、`6 (rw-)`、`5 (r-x)`、`4 (r--)`、和 `0 (---)`。

`chmod` 也支持用符号表示法来指定文件模式。符号表示法被分成三部分。

- 改变将影响谁
- 将执行哪种操作
- 将设置什么权限

要指定谁受影响，用 u、g、o、a 的字母组合。见表 9-5。

表 9-5：`chmod` 符号表示法

| 符号 | 意义                                    |
| ---- | --------------------------------------- |
| `u`  | 「user」的缩写，意指文件或目录的属主。  |
| `g`  | 属组。                                  |
| `o`  | 「others」的缩写，意指所有人。          |
| `a`  | 「all」的缩写，`u` `g` `o` 三者的组合。 |

如果没有指定字符，将假定为「all」。操作可以是 `+` 意为赋予权限，`-` 意为剥夺权限，`=` 意为仅应用指定权限且移除其他全部权限。

权限是由 `r` `w` `x` 字符来指定。表 9-6 提供了一些符号表示法的案例：

表 9-6：`chmod` 符号表示法示例

| 记号        | 意义 |
| ----------- | ---- |
| `u+x`       |      |
| `u-x`       |      |
| `+x`        |      |
| `o-rx`      |      |
| `go=rw`     |      |
| `u+x,go=rx` |      |



### 用图形界面设置文件模式



### umask - 设置默认许可



## 变更身份



### su - 用替代用户和组身份运行 shell



### sudo - 以另一个用户的身份执行命令



### chown - 变更文件的属主和组



### chgrp - 变更组的属主



## 优先权练习



## 变更密码



## 总结



## 扩展阅读

