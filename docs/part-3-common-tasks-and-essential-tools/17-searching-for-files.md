# 17. 搜索文件

当我们徘徊在 Linux 系统时，有一件事变得非常清楚：一个典型的 Linux 系统有一大堆文件！这引出了一个问题，「我们怎么才能找到东西？」我们已经知道 Linux 文件系统是依初代类 Unix 系统传下来的惯例组织的，但是绝对数量的文件可能带来令人生畏的问题。

本章中，我们将会看到两个用来查找系统中文件的工具。

- `locate` 用名称找文件
- `find` 在目录等级中搜索文件

我们还将看到一个处理文件结果列表的文件搜索命令。

- `xargs` 从标准输入建立和执行命令行

另外，还将介绍一对辅助我们浏览的命令。

- `touch` 改变文件的时间
- `stat` 显示文件或文件系统的状态

## locate - 简易的找文件方法

`locate` 程序执行快速路径名数据库的搜索，输出每一个匹配给定字符串的名称。例如，我们想找到所有文件名以 `zip` 开头的程序。由于我们要找的是程序，可以假定包含程序的目录会以 `bin/` 结尾。因此，我们可以尝试这样用 `locate` 找到所需的文件：

```bash
[me@linuxbox ~]$ locate bin/zip
```

`locate` 会搜索其路径数据库，输出任何包含字符串 `bin/zip` 的条目。

```bash
/usr/bin/zip
/usr/bin/zipcloak
/usr/bin/zipgrep
/usr/bin/zipinfo
/usr/bin/zipnote
/usr/bin/zipsplit
```

如果搜索的需求不是这么简单，我们可以将 `locate` 和其它工具如 `grep` 合并使用，来设计出更有趣的搜索。

```bash
[me@linuxbox ~]$ locate zip | grep bin
/bin/bunzip2
/bin/bzip2
/bin/bzip2recover
/bin/gunzip
/bin/gzip
/usr/bin/funzip
/usr/bin/gpg-zip
/usr/bin/preunzip
/usr/bin/prezip
/usr/bin/prezip-bin
/usr/bin/unzip
/usr/bin/unzipsfx
/usr/bin/zip
/usr/bin/zipcloak
/usr/bin/zipgrep
/usr/bin/zipinfo
/usr/bin/zipnote
/usr/bin/zipsplit
```

`locate` 程序已经有多年的历史了，并有几种常用的变体。Linux 发行版中最常用的两个是 `slocate` 和 `mlocate`，不过它们通常是由名为 `locate` 的符号链接而得以访问。不同版本的 `locate` 有着重叠的选项集。有些版本包含正则表达式匹配（我们将在第 19 章学到）并支持通配符。请查阅 `locate` 的手册页来确定已安装的 `locate` 是哪个版本。

> **locate 的数据库从哪里来的？**
>
> 你可能注意到，在有些发行版中，`locate` 在刚安装完系统后不能工作，不过第二天当你再尝试的时候，它就能正常工作了。是什么赋予了它工作的能力？`locate` 数据库有另一个名为 `updatedb` 的程序所创建。它通常由一个<u>计划任务</u>（*cron job*）周期性地运行，计划任务是指由 `cron` 守护程序定期执行的一个任务。大多数系统每天运行一次 `updatedb` 以支持 `locate` 程序。由于数据库不是持续更新的，你会注意到 `locate` 不会显示近期的文件。要克服这点，可以用超级用户权限在命令行中手动执行 `updatedb` 程序。

## find 

`locate` 程序可以单独基于文件名查找文件，`find` 程序基于各种属性搜索一个给定目录（及其子目录）中的文件。我们将会花费大量时间学习 `find`，因为它有大量有趣的特性，在后续章节中学习程序概念时会使得我们一再地查看。

最简单的用法是，给定一个或多个目录名，用 `find` 搜索。例如，要产生一份家目录的文件列表，我们会这么用它：

```bash
[me@linuxbox ~]$ find ~
```

在大多数活跃的用户帐户中，该命令会产生一份很长的列表。由于列表是被发送到标准输出的，我们可以将列表管道输出给其它程序。来用 `wc` 统计一下文件的数目。

```bash
[me@linuxbox ~]$ find ~ | wc -l
47068
```

哇，我们一直真忙！`find` 的优点在于它可用于识别符合特定条件的文件。它通过（有点奇怪）应用<u>选项</u>（*options*）、<u>测试</u>（*tests*）和<u>行为</u>（*actions*）来实现。首先来看测试。

### 测试

假设我们想要从搜索中得到一份目录的列表。要做到这点，可以加下列测试：

```bash
[me@linuxbox ~]$ find ~ -type d | wc -l
1695
```

添加 `-type d` 限制仅搜索目录。相反，我们可以限制仅搜索常规文件：

```bash
[me@linuxbox ~]$ find ~ -type f | wc -l
38737
```

表 17-1 列出了 `find` 测试所支持的常用的文件类型。

表 17-1：find 文件类型

| 文件类型 | 描述             |
| -------- | ---------------- |
| `b`      | 块特殊设备文件   |
| `c`      | 字符特殊设备文件 |
| `d`      | 目录             |
| `f`      | 常规文件         |
| `l`      | 符号链接         |

我们还可以通过文件大小和文件名，添加一些附加的测试来搜索。来搜索全部常规文件，要求匹配通配符 `*.JPG` 并大于一兆字节。

```bash
[me@linuxbox ~]$ find ~ -type f -name "*.JPG" -size +1M | wc -l
840
```

在本例中，加了 `-name` 测试紧跟其后的通配符式样。注意是如何加引号以防止路径名扩展。随后，加了 `-size` 测试随后的字符串 `+1M`。为首的 `+` 指示我们正在查找的文件大于指定数字。一个为首的 `-` 则表明小于指定数字。如无指定符号，则「精确匹配数字」。末尾 `M` 指示度量单位为兆字节。表 17-2 列出了可用于指定单位的字符。

表 17-2： find 尺寸单位

| 字符 | 单位                            |
| ---- | ------------------------------- |
| `b`  | 512 字节块。缺省计量单位。      |
| `c`  | 字节数。                        |
| `w`  | 两字节词。                      |
| `k`  | 千字节（1024 字节单位）。       |
| `M`  | 兆字节（1048576 字节单位）。    |
| `G`  | 吉字节（1073741824 字节单位）。 |

`find` 支持大量的测试。表 17-3 提供了常见的概述。请注意，在需要数字参数的情况下，可以应用上面讨论的相同的 `+` 和 `-` 符号。

表 17-3：find 测试

| 测试      | 描述 |
| --------- | ---- |
| `-cmin` *n* | 匹配那些在 *n* 分钟内修改过内容或属性的文件或目录，`-n` 指定少于 *n* 分钟，而 `+n` 指定多于 *n* 分钟。 |
| `-cnewer` *file*       | 匹配那些内容或属性修改时间比 *file* 文件的更近的文件或目录。 |
| `-ctime` *n*       | 匹配那些内容或属性最后修改时间在 *n* * 24 小时内的文件或目录。 |
| `-empty`       | 匹配空文件和空目录。 |
| `-group` *groupname*   | 匹配那些属于 *groupname* 属组的文件或目录。*groupname* 可以是组名称或者是数字形式的组 ID。 |
| `-iname` *pattern*       | 和 `-name` 测试一样，只是不区分字符大小写。 |
| `-inum` *n*        | 匹配 inode 编号为 *n* 的文件。对于查找所有链接到特定 inode 的硬链接。 |
| `-mmin` *n*        | 匹配那些最近 *n* 分钟内修改过内容的文件或目录。 |
| `-mtime` *n*        | 匹配那些最近 *n* * 24 小时内修改过内容的文件或目录。 |
| `-name` *pattern*        | 匹配通配符 *pattern* 的文件或目录。 |
| `-newer` *file*        | 匹配那些内容修改时间比 *file* 文件的更近的文件或目录。在写脚本执行文件备份时很有用。每次你创建一个备份，更新一个文件（如日志），然后用 `find` 确定从上次更新之后哪些文件变动过。 |
| `-nouser`        | 匹配那些不属于任一合法用户的文件或目录。这可以用来查找那些属于已被删除帐号的文件，或者检测攻击者的活动。 |
| `-nogroup`        | 匹配那些不属于任一合法属组的文件或目录。 |
| `-perm` *mode*        | 匹配那些权限设置等于指定 *mode* 的文件或目录。*mode* 可以是八进制或符号表示法。 |
| `-samefile` *name*        | 与 `-inum` 测试类似。匹配共享同一 *name* 的文件。 |
| `-size` *n*        | 匹配尺寸等于 *n* 的文件。 |
| `-type` *c*        | 匹配类型等于 *c* 的文件。 |
| `-user` *name*        | 匹配文件属主为 *name* 的文件或目录。用户可以是由用户名或数字用户 ID 表示。 |

以上不是一个完整的清单。`find` 手册页有完整的详述。

### 操作符



### 预定义行为



### 用户定义行为



### 增进效率



### xargs



### 回到游戏场



### 选项



## 总结



## 扩展阅读

